目前，用户的业务已经完全迁移到云平台，对于自建云平台的项目，在设计阶段涉及到的问题是如何根据业务应用的需要合理的配置硬件资源。

对于使用VMWare进行管理的虚拟化环境，有如下一些基本的约束和限制，了解这些对于对于如何配置至关重要

1. 使用物理机本地的存储(硬盘)资源，将不能实现虚拟机的故障迁移。如果要求实现故障迁移，就必须使用共享存储
2. 虚拟机的资源不能跨物理机。虚拟机的资源必须全部来源于一台物理主机
3. 物理主机上配置的全部虚拟机的资源总和，不能高于物理主机的实际资源量。否则当虚拟机资源利用率达到峰值时，会因为物理资源不足而宕机
4. 在虚拟机层面不存在弹性扩容，要实现应用的弹性配置，必须依赖于更高层面的云平台，实现虚拟机级别的动态配置
5. 在虚拟机配置中，CPU数量统一指核数，而不是颗数



下面是一个真实的案例：

XX省需要对现有云平台进行扩容以支持业务调整，虚拟机的需求如下表所示：

| 序号 | 应用             | 数量 | CPU  | 内存 | 硬盘 |
| ---- | ---------------- | ---- | ---- | ---- | ---- |
| 1    | 路方清分         | 2    | 8    | 32   | 1T   |
| 2    | 费率、计费       | 2    | 8    | 32   | 1T   |
| 3    | 部中心清分       | 2    | 8    | 32   | 1T   |
| 4    | 状态名单         | 1    | 8    | 32   | 1T   |
| 5    | 路径服务类接口   | 3    | 16   | 32   | 1T   |
| 6    | 运行监测服务器   | 1    | 16   | 48   | 1T   |
| 7    | 数据传输监控系统 | 3    | 16   | 32   | 1T   |
| 8    | 收费管理系统     | 1    | 16   | 32   | 1T   |
| 9    | 拆分结算系统     | 2    | 16   | 32   | 1T   |

为了支撑以上业务需要，需要采购的物理主机的数量和配置，才能满足以上的需要

我们假定物理主机的单机配置是已知的：2颗CPU、单颗>=20核；内存256G；硬盘4T*8

分析如下：

1. 由于虚拟机不能跨物理主机分配资源，虚拟机必须最大程度利用物理主机的资源（40核CPU、256G内存）
2. 从CPU的使用率分析
   1. 资源满配情况下，一台物理主机分配：5个8核虚拟机 / 2个16核+1个8核虚拟机 / 1个16核+3个8核虚拟机
   2. 实际需求为：10台16核虚拟机以及7台8核虚拟机
   3. 最优配置原则
      1. 5台物理机：2个16核 + 1个8核
      2. 1台物理机：2个8核（空余3个8核 / 1个16核+1个8核，可以作为故障迁移使用）
3. 从内存的使用率分析
   1. 资源满配情况下，一台物理主机分配：8个32G虚拟机 / 5个48G虚拟机 / 多种组合
   2. 实际需求为：16台32G虚拟机以及1台48G虚拟机
   3. 最优配置原则
      1. 2台物理机：8个32G
      2. 1台物理机：1个48G
4. 结合CPU和内存的最优分配方案
   1. 4台物理机：2个16核32G + 1个8核32G（分配资源：40核、96G）
   2. 1台物理机：1个16核32G + 1个16核48G + 1个8核32G（分配资源：40核、112G）
   3. 1台物理机：2个8核32G（分配资源：16核、64G）