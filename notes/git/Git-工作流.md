title: 4.Git-工作流
date: 2019-03-01
tags: GIT
categories: 配置管理
layout: post

------

摘要：文本是使用Git进行代码管理的第四篇文章，重点介绍：团队开发模式下开发的工作流以及如何使用远程仓库进行开发的共享和集成。通过本文可以了解常用的几种工作流、远程仓库的两种使用方式。

<!-- more -->

## 回顾

前面三篇文章介绍了Git的基本概念、分支、远程仓库和远程分支的基本用法，在这里简要回顾一下。

### Git

Git 是分布式版本控制系统，其特点是：不依赖于服务端就可以独立工作；速度和性能较集中式版本管理系统高出不少；生态完善，与代码评审、代码质量检查、单元和集成测试、编译和发布等第三方工具很好的集成，实现CI/CD的自动化。

1. Git 安装。支持Widnows、MacOS、Linux等操作系统
2. Git 工具。很多第三方 Git 管理工具，与集成开发工具：如Eclipse、VS Code等集成。简化操作的复杂度。
3. Git 仓库。本地的文件目录，使用`git init`初始化为仓库，将管理的文件存放在`.git`目录下。
4. Git 文件。版本数据由`blob`、`tree`、`commit`三类文件组成**快照**，使用`branch`、`HEAD`、`tag`三类引用管理快照
5. Git 工作区。包括`工作区`、`暂存区`、`版本仓库`，工作区是我们编写代码的工作目录、暂存区是代码变更的缓存、版本仓库实际存放版本数据。
6. Git 操作。初始化仓库`git init`、配置`git config`、添加到暂存区`git add`、提交到仓库`git commit`等

### 分支

分支是 Git 的核心概念，也称为 Git 的"必杀技"。使用分支可以快速切换版本和开发场景，减少多人开发模式下的冲突。

1. 分支概念。分支是指向提交的引用。通过移动分支指向的提交可以快速切换版本；不同分支间版本相互独立，很好的支持并行开发。
2. 分支操作。分支的创建`git branch`、分支的切换`git checkout`、分支的删除`git branch -d`、分支的合并`git merge`
3. 分支合并。根据合并的两个分支的关系，分为`fast forward`和三方合并。三方合并时可能出现文件冲突，需要人工处理。

### 远程仓库

在网络上的 Git 版本库，用于备份、集成、共享等用途。远程仓库原则上是一个裸仓库，不支持提交操作。

1. 裸仓库。没有工作区的 Git 仓库，通过`git init  —bare`创建
2. 通信协议。支持`https`和`ssh`加密传输，`ssh`使用公钥进行身份认证，可以不用输入用户名和密码，建议采用`ssh`方式与远程仓库通信。
3. 部署。不建议自行部署，可以采用`github`、`gitlab`、国内的托管服务（Gitee、Coding等）
4. 配置。本地用户名和密码、服务器注册用户名和密码、`ssh key`的生成和远程仓库配置、本地添加远程仓库引用。

### 远程分支

远程分支是存储在远程仓库中的分支，只能通过`git push`、`git fetch`、`git pull`等方式在远程仓库与本地仓库间进行分支的数据交换。

1. 远程分支。是存储卡在远程仓库的分支，本地不能直接操作。
2. 远程跟踪分支。是远程分支在本地仓库的只读副本，每次使用`git clone`、`git fetch`操作时，将远程分支拉取到本地，这样可以减少与远程仓库的通信压力，远程跟踪分支只在以上操作时才进行同步，因此会落后于远程分支。
3. 跟踪分支。是本地分支，但它与远程分支建立了跟踪关系，可以简化分支的拉取和推送操作，并且可以了解本地分支与远程分支间的差异。`git clone`、`git checkout -trace`和 `git branch -u`操作可以创建跟踪分支。
4. 分支操作。远程分支的推送`git push`和拉取`git fetch`、`git pull`，在本地仓库和远程仓库间交换分支提交历史。

## 工作流

我们已经了解到，使用 Git 分支进行版本管理的高效和便捷。但要更好的使用分支来胜任团队协同开发，就需要根据团队研发管理特点，制定有针对性的工作流。

下面介绍常见的几种工作流，了解它们能帮助我们发现适合自身团队的工作流。

### 集中式工作流

集中式工作流就像我们使用 SVN 等集中式版本管理系统一样。

![集中式工作流](./assets/center-flow.png)

1. 无论本地仓库还是远程仓库（中央仓库）都只有一个默认的分支`master`
2. 所有团队成员的工作都是在`master`分支上进行的
3. 开始工作前，团队成员从中央仓库拉取`master`分支到本地仓库
4. 在本地`master`分支上完成开发工作并提交更新
5. 将本地`master`分支直接推送到中央仓库
6. 本地合并分支时产生的冲突必须在本地解决

集中式工作流比较适合从 SVN 迁移到 Git 的团队。

1. 中央仓库只作为项目代码共享和备份使用
2. 不强制要求对提交代码进行审查和测试
3. 由于`master`分支开放了写入的权限，有可能因误操作造成提交历史被错误覆盖

因此集中式工作流可以作为团队初期熟悉 Git 的一种过渡或者是在个人仓库上使用。**不推荐在实际项目中应用**

### 特性分支工作流

特性分支工作流，是将所有的特性开发放在专门的分支（而不是`master`分支）上。这样就起到了隔离作用，使得特性分支不会影响主干`master`代码。保证了`master`分支的代码是可运行的，有利于项目持续集成。

![功能分支工作流](./assets/feature-flow.png)

特性分支工作流是使用 Git 进行开发的标准用法，后续介绍的几种工作流都是特性分支工作流的变种。在特性分支工作流的使用中，普遍采用`Pull Request`模式，可以在合并代码时进行代码评审。

**Pull Request**。`Pull Request`的意思是，你把版本变更提交到仓库后，给项目负责人和相关人员发出一个请求`Request`，相关人员收到请求后，对你提交的变更进行审查和评论，最后由项目负责人将你提交分支`Pull`到项目的主干分支`master`，最终完成版本整合的工作。

采用这种方式有很多的好处：

1. 可以在不同仓库间进行`Pull Request`操作，如`Fork`模式就是在不同的仓库间进行整合
2. 在正式整合到主干分支前，对提交的版本变更进行审查`Code review`，提高代码的质量
3. 主干分支写操作受限，避免主干分支因误操作导致版本信息被覆盖

### Fork工作流

`Fork`工作流是特性分支工作流的一个变种，区别在于本地分支有两个上游分支（远程分支），个人远程仓库的分支以及团队远程仓库的分支。

![Fork工作流](./assets/fork-flow.png)

`Fork`工作流的特点是项目维护者可以接受任何开发者的提交，但无需给他正式代码库的写权限。能为大型、自发性的团队（包括了不受信的第三方）提供灵活的方式来安全的协作。成为**开源项目**的理想工作流。

具体操作步骤：

1. 开发人员将团队的中央仓库`Fork`到个人的中央仓库中
2. 开发人员将个人仓库`Clone`到本地
3. 开发人员在本地创建特性分支
4. 开发人员在特性分支上进行变更操作并提交
5. 开发人员将本地特性分支`Push`到个人中央仓库
6. 发起`Pull Request`给团队负责人
7. 团队负责人将发起者个人中央仓库中的特性分支合并到团队中央仓库的主干分支
8. 开发人员从团队中央仓库将主干分支拉取到本地

## Git Flow

Git Flow 是 Git 官方推荐的基于分支的工作流，它是特性分支工作流的变种，适用于大型项目的开发。

Git Flow 非常复杂，属于重量级的工作流，它规定了用于不同用途的分支以及不同场景下的分支流程。

![img](./assets/git-flow.png)

### 分支介绍

在`gitflow`中对使用的分支进行了约定，如下表所示

| 分支名称 | 分支类型 | 命名规范   | 分支说明                                                     |
| -------- | -------- | ---------- | ------------------------------------------------------------ |
| 主干分支 | 长期分支 | `master`   | 记录发布版本的分支。对于持续迭代项目，通过添加`Tag`标签标注版本 |
| 修复分支 | 临时分支 | `fix_`     | 对发布版本进行修复的分支。当发布版本发现`Bug`后，从主干分支创建修复分支对代码进行修复。修复完成后删除该分支 |
| 发布分支 | 临时分支 | `release_` | 新版本发布预处理分支。在发布节点到来前，从开发分支创建发布分支对新版本进行测试和`Bug`修复处理 |
| 开发分支 | 长期分支 | `dev`      | 集成开发分支。特性开发工作是基于开发分支而不是主干分支进行的，它通常会领先于主干分支 |
| 特性分支 | 临时分支 | `fea_`     | 新功能开发使用的独立分支。特性分支从开发分支创建并合并进开发分支中 |

**两个长期分支**。不同于一个**长期分支**的分支流程，`gitflow`使用两个长期分支。**主干分支**关注已发布版本，**开发分支**关注开发进程。**开发分支**从**主干分支**创建，之后两个分支处于平行状态，不会在项目进行过程中有任何的**交集**。

**两次合并**。对于**修复分支**和**发布分支**，在完成相应工作后，都需要合并进**主干分支**和**开发分支**。这样才能保证两个长期分支代码的一致。

**版本标签**。对于持续迭代的项目（不会同时存在多个运行版本），使用`Tag`标签可以对发布版本进行**具名**的标注，便于在需要时检出版本。对于同时存在多个运行版本的情况，建议增加相应版本的长期分支，即多个**主干分支**，可以使用版本号进行分支命名，如**V1.0**、**V2.0**等。

### 分支流程

`gitflow`的分支流程非常复杂，下面以常见场景进行分别介绍

**准备阶段**。在准备阶段，项目负责人需要创建远程仓库和两个长期分支。

1. 创建远程仓库。在代码托管平台上，创建项目仓库
2. 将项目仓库克隆到本地
3. 在本地主干分支`master`提交初始开发，如项目脚手架生成的代码等
4. 基于主干分支`master`创建开发分支`dev`
5. 将两个分支推动到远程仓库中

**特性开发阶段**。项目开发人员根据任务分工，开发自己负责的特性部分。

1. 克隆远程仓库 / 拉取远程分支。开发人员克隆远程仓库 或者 从远程仓库拉取分支最新状态
2. 开发人员基于`origin/dev`远程跟踪分支创建特性分支`fea_xxx`
3. 在特性分支`fea_xxx`上完成代码的开发和测试工作
4. 将通过测试的代码提交到特性分支`fea_xxx`，并推送到远程仓库中
5. 在代码托管平台，发起`Pull Request`将特性分支`fea_xxx`合并到开发分支`dev`
6. 审查人员对代码审查完成后，项目负责人将特性分支`fea_xxx`合并到开发分支`dev`

**版本发布阶段**。在版本里程碑节点，将要发布功能进行测试、修复后发布到主干分支并更新开发分支。

1. 拉取远程仓库中开发分支`dev`的最新状态
2. 基于开发分支`origin/dev`创建发布分支`release_xxx`
3. 对发布分支的项目代码进行集成测试和修复工作
4. 将发布分支`release_xxx`推动到远程仓库
5. 在代码托管平台，发起`Pull Request`将发布分支合并到主干分支`master`和开发分支`dev`
6. 审查人员对代码审查完成后，项目负责人将发布分支`release_xxx`合并到主干分支`master`和开发分支`dev`
7. 项目负责人在主干分支`master`创建版本标签`Vx.xx`

**Bug修复阶段**。对线上运行版本反馈的`Bug`进行修复时，需要基于主干分支`master`创建修复分支`fix_xxx`。

1. 拉取远程仓库中主干分支`master`的最新状态
2. 基于主干分支`origin/master`创建修复分支`fix_xxx`
3. 对修复分支`fix_xxx`的代码进行修复和测试工作
4. 将修复分支`fix_xxx`推动到远程仓库
5. 在代码托管平台，发起`Pull Request`将修复分支合并到主干分支`master`和开发分支`dev`
6. 审查人员对代码审查完成后，项目负责人将修复分支`fix_xxx`合并到主干分支`master`和开发分支`dev`
7. 项目负责人在主干分支`master`创建版本标签`Vx.xx`

## GitHub Flow

GitHub Flow是一个基于分支的轻量级工作流，支持定期进行部署的团队和项目。

![Github flow](./assets/github-flow.png)

1. Github Flow 只有一个长期分支`master`，`master`分支上的代码是可以部署的版本。

2. 任何特性开发、预发布、Bug修复，都是在基于`master`分支创建的分支上进行的，分支的名称应该是描述性的以便于协作者能够清楚。
3. 在分支上开发完成后，使用`Pull Request`合并到主分支`master`
4. GitHub Flow非常简单，由于缺少必要的质量管控流程，对于代码质量和进度一致性等要求较高。

## GitLab Flow

![GitLab 生产分支](./assets/gitlab-prod-flow.png)

GitLab Flow在`git flow`基础上简化了开发相关的分支（开发分支、发布分支、修复分支），在`github flow`基础上增加了生产分支`production`。主要是出于以下考虑：

1. 开发模式普遍采用持续迭代，因此像`git flow`区分特性分支、修复分支和发布分支就显得有些多余且不适应开发模式；修复分支和发布分支需要同时合并到两个长期分支（主干分支和开发分支），操作失误可能导致版本的不一致
2. 实际部署环节，大多数项目不能做到主干分支更新后同步上线，需要在上线前做好准备，在规定时间节点上线新版本；大多数项目还是需要区分不同版本，在主干分支打标签的方式，实际使用中不够方便
3. 默认分支是`master`，每次切换到`dev`分支，会增加出错概率

**持续集成**

![gitlab环境分支](./assets/gitlab-envi-flow.png)

对于"持续发布"的项目，建立不同的环境分支。"预发布环境"的分支是pre-production，"生产环境"的分支是production。

主干分支是预发分支的"上游"，预发分支又是生产分支的"上游"。代码的变化，必须由"上游"向"下游"发展。比如，生产环境出现了bug，这时就要新建一个功能分支，先把它合并到主干分支，确认没有问题，再cherry-pick到pre-production，这一步也没有问题，才进入production。

**版本发布**

对于"版本发布"的项目，GitLab Flow也提供了相应的分支模型。每一个稳定版本，都要从主干分支`master`拉出一个版本分支，比如2-3-stable、2-4-stable等等。当需要修补bug时，才允许将代码合并到这些分支，并且更新小版本号。

![GitLab版本分支](./assets/gitlab-release-flow.png)

## 工作流总结

1. 任何时候都不要在主干分支`master`上进行提交操作（代码变更），功能开发、Bug修复都在开发分支上进行
2. 不要在本地将开发分支合并到主干分支上，将本地开发分支推送到服务端，通过`Pull Request`进行审查和合并
3. Fork 工作流更适合开源项目，任何人都可以提交新版本，而项目所有人也不用管理用户权限
4. `Pull Request`对合并进主干分支的代码提供代码审查机制，这种机制可以提高代码质量
5. 如果团队有较为完善的单元测试、集成测试、自动部署的流程，适合使用GitHub Flow这种轻量级的工作流
6. GitLab Flow兼顾了持续集成和版本发布两种应用场景，适合大部分团队和项目的开发

**注意事项**

1. 采用语义版本，给定版本号MAJOR.MINOR.PATCH
2. 重视提交消息的正确书写，提交消息应该反映你的意图，而不仅仅是提交的内容
3. 减少功能分支中的合并提交，可以通过`rebase`或`cherry-pick`对提交历史进行重新排序，使得提交历史更清晰易懂
4. 尽量减少在每个功能分支上的持续时间，建议每个功能分支的工作时长控制在1天时间，这将更有利于协同开发
5. 功能分支在正式合并到主干分支前，应该做好测试工作，避免频繁的创建修复分支，导致主干分支混乱

