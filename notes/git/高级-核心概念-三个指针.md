# 核心概念（三个指针）

上一节介绍了`git`的三个重要的对象（`commit`、`tree`、`blob`），这三个对象是`git`的存储对象，是实现版本管理的核心和基础。本节来说一说`git`的上层建筑，`HEAD`、`tag`、`branch`这三驾马车是实现`git`灵活、高效的核心。

> 后续章节会有关于`HEAD`和`branch`的更详细的介绍

![Commit Branch Tag HEAD关系](./assets/branch-and-history.png)

## branch

如果说`commit`实现了对数据文件的版本管理，那么利用`branch`可以实现对多个版本的并行工作而之间互不影响。

### 是什么？

1. 本质上是指向提交对象的**可变**指针

   在当前`branch`进行提交操作后，会移动到新的`commit`对象

2. 是一个文件（存储在`.git/refs/heads/`目录）

   文件内容是其指向的`commit id`

3. 默认`branch`名字是 `master`

   在初始化仓库时由 Git 自动创建的

**注：新创建的配置库(没有提交过)，并没有`master`分支对象(在`.git/refs/heads/`目录中不存在)**

### 作用

在`Git`版本控制中，起到了重要的作用

1. 多个任务并行开展互不影响（如：当前发布版本、下一版本功能、问题修复、优化重构等）

2. 通过`branch`快速切换工作任务

分支实质上仅是包含所指对象校验和（长度为 40 的 SHA-1 值字符串）的文件，所以它的创建和销毁都异常高效。 创建一个新分支就相当于往一个文件中写入 41 个字节（40 个字符和 1 个换行符）如此的简单能不快吗？



### 创建

创建`branch`非常简单和快速，因为`git`中创建`branch`并不需要复制一份仓库文件的副本（其他版本控制需要）

![创建分支](./assets/head-to-master.png)

使用`git branch <分支名称>`指令，该指令会在当前`branch`上，创建一个新的`branch`，如上图所示

该指令不会切换当前的`branch`，如果需要切换到新创建的`branch`，使用切换指令

**注：当前`branch`是`HEAD`指向的`branch`或者`commit id`**

```shell
# 创建一个新的分支
$ git branch testing

# 查看分支
# git branch -v
  testing   46b5bd7 Add three.md
* master 	46b5bd7 Add three.md # 最前面的 * 号，表示当前工作在这个分支上
```



### 切换

切换操作将执行两个任务

1. 将`HEAD`指针指向目标分支
2. 将工作目录和暂存区恢复成目标分支指向的快照（即`commit`）
   - 切换前 工作目录 如果有 未跟踪 文件，切换不影响该文件（继续存在）。
   - 切换前 暂存区 如果有 未提交 文件，切换后自动将这些文件添加到 分支中（将影响分支）。
3. 在切换前，需要清理暂存区，保持暂存区是干净的。

![切换分支](./assets/head-to-testing.png)

使用`git checkout <分支名称>` 指令，该指令可以切换`branch`，还可以将创建和切换合二为一

```shell
# 切换到 testing 分支上
$ git checkout testing
Switched to branch testing

# 切换并创建分支 testing，使用 -b 参数开关
# git checkout -b testing
Switched to a new branch testing
```



### 删除

```shell
# 查看分支
$ git branch -v
  dev     46b5bd7 Add three.md
* master  46b5bd7 Add three.md
  testing 46b5bd7 Add three.md

# 删除分支 testing
$ git branch -d testing
Deleted branch testing (was 46b5bd7).

# 如果删除当前工作分支，git 会提示如下错误
error: Cannot delete branch testing checked out at <工作目录>
```

**注：思考一下，为什么不能删除当前工作分支呢？**

答案是：`HEAD`指针丢失，而`HEAD`指针必须指向一个`branch`或者`commit`

### 合并

```shell
On branch master
You have unmerged paths.
  (fix conflicts and run "git commit")
  (use "git merge --abort" to abort the merge)

Unmerged paths:
  (use "git add <file>..." to mark resolution)

	both modified:   three.md

no changes added to commit (use "git add" and/or "git commit -a")
```





## tag

标签本质上是指向提交对象的**固定**指针。通过给重要的提交 `commit` 添加标签(语义化)，来方便定位。比较代表性的使用场景是用来标记发布节点 ( 如 V1.0 等)

- 标签可以看做是`commit`的语义化描述
- 标签主要用于只读场景，即通过标签获得仓库中的数据文件
- 标签较多用来标记发布节点

```shell
# 添加标签
$ git tag v1.0 -m'v1.0'

# 查看标签
$ git tag
v1.0

# 标签存放在refs/tags目录下
$ cd refs/tags
$ ls -l
total 8
-rw-r--r--  1 lijie  staff  41 12 13 18:24 v1.0

# 标签文件中存放的内容是 tag对象
$ cat v1.0
0c2bfdbd52d00bb2da5f7b3b5b2047a412301d5f
$ git cat-file -t 0c2bfdbd
tag

# tag对象中存放内容
$ git cat-file -p 0c2bfdbd
object 72931be9bab7ba7e5c58ae1d80bdf2b959eda48d # commit对象
type commit
tag v1.0
tagger lijiemac <lijie@boco.com.cn> 1544696684 +0800 # 谁打的标签

v1.0  # 标签备注

```



## HEAD

`HEAD`是当前操作`branch`或者`commit`的指针。

- `git`存在多个`branch`，为了记录当前操作的`branch`，使用`HEAD`
- 每个仓库`repo`只有一个`HEAD`
- 在`.git/`目录中存储