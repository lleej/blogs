> 2018.12.25

# 计算原理

> 数据对象、树对象、提交对象

## 定义

1. 数据对象

   指`Git`管理的所有文件

   类型：`blob`

2. 树对象

   可以理解为目录，根树对象(`commit`中)是一个归集

   类型：`tree`

3. 提交对象

   当前仓库管理的版本的一个快照

   类型：`commit`

## 公式

```shell
header = <object type> + 空格 + <content length> + \0
hash = sha1(header + content)
```

- 计算哈希值的内容由两部分组成：头信息(header)和内容信息(content)

- 头信息由对象类型、内容长度和空字符组成

  - 对象类型 = [`blobl` | `tree` | `commit`]，明确对象
  - 内容长度 = 字节长度，不是字符串长度（中文的长度 !== 字节长度）
  - 空字符 = `\0`字符，起到分隔作用

- 内容信息

  不同类型对象，其内容信息不同

## 数据对象

**数据对象的哈希计算，不包含文件名**

```shell
header = blob <content length>\0
hash = sha1(<header><conent>)
```

示例如下：

```shell
# 计算内容的长度
$ echo -n "您好" | wc -c
  6
# 使用 git 的 hash 计算
$ echo -n "您好" | git hash-object --stdin
08c34184856086e2b1a02e81250bec00dd55e2ea
# 使用openssl 的 hash 计算
$ echo -n -e "blob 6\0您好" | openssl sha1
08c34184856086e2b1a02e81250bec00dd55e2ea

# 证明计算的格式是正确的
```



## 树对象

```shell
header = tree <content length>\0
content = <file mode> <filename>\0<item sha二进制>...
hash = sha1(<header><conent>)
```

- `file mode`
- `item sha` 是二进制的`sha`码

```shell
# 查看根树的内容
$ git cat-file -p 8c3d2
040000 tree 7cd194af54b759f0949bf26e7bbdf4c9325f1c29	1
040000 tree 7cd194af54b759f0949bf26e7bbdf4c9325f1c29	2
100644 blob 1bccab5e6f5a1222ae039f0df19f9a66a1c0e558	test.txt

# 查看其中 树7cd19 的内容
$ git cat-file -p 7cd19
100644 blob 1bccab5e6f5a1222ae039f0df19f9a66a1c0e558	test.txt

# 计算 树7cd19 中包含内容的哈希值的 二进制码
$ echo -n 1bccab5e6f5a1222ae039f0df19f9a66a1c0e558 | xxd -r -p >sha1.txt
# 加入 <file mode> 和 <filename>
$ echo -n -e "100644 test.txt\0" | cat - sha1.txt > content.txt 
# 计算 内容 的长度
$ cat content.txt | wc -c
  36
# 加入 header 部分 并计算哈希值
$ echo -n -e "tree 36\0" | cat - content.txt | openssl sha1
7cd194af54b759f0949bf26e7bbdf4c9325f1c29

## 结论：通过自行计算的哈希值 与 git计算的哈希值一致
```



## 提交对象

```shell
header = commit <content length>\0
content = tree <tree sha>
parent <parent sha>
[parent <parent sha>]
author <author name> <author email> <timestamp> <timezone>
committer <commiter name> <committer email> <timestamp> <timezone>

<commit message>
hash = sha1(<header><conent>)
```

- 内容部分每一项后加入`\n`换行符，`<commit message>`前再加入一个换行符
- 内容部分涉及`sha`值不需要转换为二进制了
- 如果有多个`parent`，则都需要列出来

```shell
# git中 commit 6ea06 的内容
$ git cat-file -p 6ea06
tree 8c3d22921e28aed901bb57bd7c3cf2be06b85619
author lijiemac <lijie@boco.com.cn> 1545703889 +0800
committer lijiemac <lijie@boco.com.cn> 1545703889 +0800

aaa

# 计算内容长度
$ echo -n -e "tree 8c3d22921e28aed901bb57bd7c3cf2be06b85619\nauthor lijiemac <lijie@boco.com.cn> 1545703889 +0800\ncommitter lijiemac <lijie@boco.com.cn> 1545703889 +0800\n\naaa\n" | wc -c
  160

# 加入 header 部分 并计算哈希值
$ echo -n -e "commit 160\0tree 8c3d22921e28aed901bb57bd7c3cf2be06b85619\nauthor lijiemac <lijie@boco.com.cn> 1545703889 +0800\ncommitter lijiemac <lijie@boco.com.cn> 1545703889 +0800\n\naaa\n" | openssl sha1
6ea063d24ed546cd9c75c16989d5c04774459f09

## 结论：通过自行计算的哈希值 与 git计算的哈希值一致
```



# 深入分析

## 内容相同的数据对象，保存为一个Blob文件

- 数据对象的哈希值计算 仅与其内容相关，与文件名称和所在位置无关

##目录中文件相同（数量、名称、内容），保存为一个Tree文件

- 数对象的哈希值计算 仅与其中包含的 文件名 文件哈希值 有关，与其目录名称无关

##演示

- 创建一个名称为`test.txt`文件，其内容为`您好，我是一个测试文件。`
- 将这个文件复制到 目录`1`和目录`2`下。这样在工作目录中就存在三个相同的`text.txt`文件和两个包含相同内容的目录`1`和`2`
- 将这三个文件提交后，查看仓库中如何存储这些文件的

### 第一步 创建文件和目录

```shell
# 创建一个文件
$ echo "您好，我是一个测试文件。" > test.txt
# 将文件拷贝到新创建的目录1中
$ mkdir 1
$ cp test.txt 1
# 将文件拷贝到新创建的目录2中
$ mkdir 2
$ cp test.txt 2
# 查看工作目录中的文件
$ ls -l
total 8
drwxr-xr-x  3 lijie  staff  96 12 25 10:08 1
drwxr-xr-x  3 lijie  staff  96 12 25 10:08 2
-rw-r--r--  1 lijie  staff  37 12 25 10:07 test.txt

# 查看仓库状态
$ git s
On branch master
No commits yet
Untracked files:
  (use git add <file>... to include in what will be committed)

	1/
	2/
	test.txt
nothing added to commit but untracked files present (use git add to track)
```



###第二步 将文件提交到暂存区

```shell
# 提交到暂存区
$ git add .
$ git s
On branch master
No commits yet
Changes to be committed:
  (use git rm --cached <file>... to unstage)
	new file:   1/test.txt
	new file:   2/test.txt
	new file:   test.txt

# 提交到暂存区 已经在仓库中创建了 数据对象
# 只有一个数据文件
$ ls .git/objects
1b	info	pack
$ ls .git/objects/1b
ccab5e6f5a1222ae039f0df19f9a66a1c0e558
# 文件内容为
$ git cat-file -p 1bcca
您好，我是一个测试文件。
```



### 第三步 将暂存区文件提交到仓库中

```shell
# 提交到仓库中
$ git commit -m'aaa'
[master (root-commit) 6ea063d] aaa
 3 files changed, 3 insertions(+)
 create mode 100644 1/test.txt
 create mode 100644 2/test.txt
 create mode 100644 test.txt

# 查看仓库中存储的对象
# 有四个对象
$ ls .git/objects
1b	6e	7c	8c	info	pack

# 6e开头的是 commit对象 

# 1b开头的是 blob对象  
# 从这里看出，工作目录中三个文件，实际存储为1个对象
$ git cat-file -p 1bcca
您好，我是一个测试文件。

# 7c开头的是 tree对象
$ git cat-file -p 7cd19
100644 blob 1bccab5e6f5a1222ae039f0df19f9a66a1c0e558	test.txt

# 8c开头的是 tree对象
# 从这里可以看出 目录1 和 目录2 公用一个 tree对象
$ git cat-file -p 8c3d2
040000 tree 7cd194af54b759f0949bf26e7bbdf4c9325f1c29	1
040000 tree 7cd194af54b759f0949bf26e7bbdf4c9325f1c29	2
100644 blob 1bccab5e6f5a1222ae039f0df19f9a66a1c0e558	test.txt
```

